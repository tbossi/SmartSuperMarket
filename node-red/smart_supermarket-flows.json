[
  {
    "id": "11b01065.87c36",
    "type": "tab",
    "label": "Shelves",
    "disabled": false,
    "info": "Tutti i flussi riguardanti gli scaffali/banconi:\n\n1) Gestione temperature banco frigo\n2) Gestione prodotti presenti sugli scaffali"
  },
  {
    "id": "e2590d70.33a478",
    "type": "tab",
    "label": "Theft Protection Totems",
    "disabled": false,
    "info": ""
  },
  {
    "id": "186b7a65.42ec46",
    "type": "tab",
    "label": "Carts",
    "disabled": false,
    "info": ""
  },
  {
    "id": "175c22d2.0ef64d",
    "type": "tab",
    "label": "Management Web Form",
    "disabled": false,
    "info": ""
  },
  {
    "id": "75994a9b.4846ac",
    "type": "subflow",
    "name": "TCP SET Raw value",
    "info": "",
    "in": [
      {
        "x": 40,
        "y": 80,
        "wires": [
          {
            "id": "8f0eb1ed.19dea"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 760,
        "y": 80,
        "wires": [
          {
            "id": "f7b77fa8.c2f88",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "9764201b.6e44f8",
    "type": "subflow",
    "name": "TCP GET Raw value",
    "info": "",
    "in": [
      {
        "x": 40,
        "y": 80,
        "wires": [
          {
            "id": "bb3021cf.9d2418"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 760,
        "y": 80,
        "wires": [
          {
            "id": "e662febb.30f3f8",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "1c278488.7d6afb",
    "type": "subflow",
    "name": "Mongo - Change product availability",
    "info": "",
    "in": [
      {
        "x": 60,
        "y": 100,
        "wires": [
          {
            "id": "bf7f4322.4baca"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 960,
        "y": 200,
        "wires": [
          {
            "id": "6035985e.0b62e",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "821fa547.1b5ce8",
    "type": "subflow",
    "name": "Mongo get market map",
    "info": "",
    "in": [
      {
        "x": 80,
        "y": 70,
        "wires": [
          {
            "id": "92218ff1.234658"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 640,
        "y": 70,
        "wires": [
          {
            "id": "36f1a4d5.84703c",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "ca9d5af1.bc0ea8",
    "type": "subflow",
    "name": "Mongo get all product",
    "info": "",
    "in": [
      {
        "x": 40,
        "y": 20,
        "wires": [
          {
            "id": "36cb8568.df137a"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 660,
        "y": 20,
        "wires": [
          {
            "id": "97983c7e.ee6eb8",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "6306fa17.2370dc",
    "type": "subflow",
    "name": "Mongo update price",
    "info": "",
    "in": [
      {
        "x": 50,
        "y": 30,
        "wires": [
          {
            "id": "afc44443.15a23"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 760,
        "y": 20,
        "wires": [
          {
            "id": "6fe7e765.9bc12",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "9cddb094.21ea78",
    "type": "subflow",
    "name": "Every 250ms",
    "info": "",
    "in": [],
    "out": [
      {
        "x": 500,
        "y": 90,
        "wires": [
          {
            "id": "67ce8bb5.4a9d84",
            "port": 0
          },
          {
            "id": "24f191ba.f9637e",
            "port": 0
          },
          {
            "id": "723021e6.3065a8",
            "port": 0
          },
          {
            "id": "64646f7a.f0b79",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "cc688324.604068",
    "type": "subflow",
    "name": "Mongo Change products in cart",
    "info": "",
    "in": [
      {
        "x": 50,
        "y": 110,
        "wires": [
          {
            "id": "cbeb4b03.74f648"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 950,
        "y": 260,
        "wires": [
          {
            "id": "489d6e02.f26a9",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "e5049f4c.fd313",
    "type": "subflow",
    "name": "Mongo get product from id",
    "info": "",
    "in": [
      {
        "x": 70,
        "y": 70,
        "wires": [
          {
            "id": "5d3b2b89.9533c4"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 670,
        "y": 70,
        "wires": [
          {
            "id": "2987129.e504b6e",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "54963c28.722b74",
    "type": "subflow",
    "name": "Mongo Get products in cart",
    "info": "",
    "in": [
      {
        "x": 50,
        "y": 90,
        "wires": [
          {
            "id": "9c8f8645.4ea7d8"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 990,
        "y": 70,
        "wires": [
          {
            "id": "b39443e4.88fb58",
            "port": 0
          },
          {
            "id": "ec624000.a5d6f",
            "port": 0
          }
        ]
      }
    ]
  },
  {
    "id": "dcdbb1c1.7b8b3",
    "type": "ui_base",
    "theme": {
      "name": "theme-light",
      "lightTheme": {
        "default": "#0094CE",
        "baseColor": "#0094CE",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "edited": true,
        "reset": false
      },
      "darkTheme": {
        "default": "#097479",
        "baseColor": "#097479",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "edited": false
      },
      "customTheme": {
        "name": "Untitled Theme 1",
        "default": "#4B7930",
        "baseColor": "#4B7930",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "reset": false
      },
      "themeState": {
        "base-color": {
          "default": "#0094CE",
          "value": "#0094CE",
          "edited": false
        },
        "page-titlebar-backgroundColor": {
          "value": "#0094CE",
          "edited": false
        },
        "page-backgroundColor": {
          "value": "#fafafa",
          "edited": false
        },
        "page-sidebar-backgroundColor": {
          "value": "#ffffff",
          "edited": false
        },
        "group-textColor": {
          "value": "#1bbfff",
          "edited": false
        },
        "group-borderColor": {
          "value": "#ffffff",
          "edited": false
        },
        "group-backgroundColor": {
          "value": "#ffffff",
          "edited": false
        },
        "widget-textColor": {
          "value": "#111111",
          "edited": false
        },
        "widget-backgroundColor": {
          "value": "#0094ce",
          "edited": false
        },
        "widget-borderColor": {
          "value": "#ffffff",
          "edited": false
        },
        "base-font": {
          "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
        }
      }
    },
    "site": {
      "name": "Smart Supermarket Dashboard",
      "hideToolbar": "false",
      "allowSwipe": "false",
      "dateFormat": "DD/MM/YYYY",
      "sizes": {
        "sx": 48,
        "sy": 48,
        "gx": 6,
        "gy": 6,
        "cx": 6,
        "cy": 6,
        "px": 0,
        "py": 0
      }
    }
  },
  {
    "id": "cc40c5fa.c756c8",
    "type": "ui_tab",
    "z": "",
    "name": "Shelves",
    "icon": "dashboard"
  },
  {
    "id": "fd9e676c.85fd6",
    "type": "ui_group",
    "z": "",
    "name": "Temperature",
    "tab": "cc40c5fa.c756c8",
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "d8a581dc.b0cfa8",
    "type": "mongodb2",
    "z": "",
    "uri": "mongodb://localhost/smart_supermarket",
    "name": "Local MongoDB",
    "options": "",
    "parallelism": "-1"
  },
  {
    "id": "6c5f366c.b6c0f8",
    "type": "mqtt-broker",
    "z": "",
    "broker": "localhost",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "compatmode": true,
    "keepalive": "60",
    "cleansession": true,
    "willTopic": "",
    "willQos": "0",
    "willPayload": "",
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": ""
  },
  {
    "id": "366b0688.9c8872",
    "type": "ui_tab",
    "z": "",
    "name": "Carts",
    "icon": "dashboard"
  },
  {
    "id": "9d4a3a62.d7ce4",
    "type": "ui_group",
    "z": "",
    "name": "Carts positions",
    "tab": "366b0688.9c8872",
    "disp": true,
    "width": "20",
    "collapse": false
  },
  {
    "id": "49992fa3.4072f",
    "type": "inject",
    "z": "11b01065.87c36",
    "name": " temperature change crontab",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "repeat": "30",
    "crontab": "",
    "once": false,
    "x": 180,
    "y": 120,
    "wires": [
      [
        "56acca35.ed11bc"
      ]
    ]
  },
  {
    "id": "56acca35.ed11bc",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "generate random temperature",
    "func": "function getRandomInt(min, max) {\n    return (Math.random() * (max - min + 1) + min).toFixed(1);\n}\n\nmsg = {};\nmsg.device = \"shelf\";\nmsg.deviceId = \"S1_Temp\";\nmsg.value = getRandomInt(0.5, 3.5);\nmsg.payload = `Forced change temperature to ${msg.value}`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 470,
    "y": 120,
    "wires": [
      [
        "97546f0b.21e3a"
      ]
    ]
  },
  {
    "id": "9e926b17.bf9b5",
    "type": "tcp request",
    "z": "75994a9b.4846ac",
    "server": "localhost",
    "port": "",
    "out": "time",
    "splitc": "0",
    "name": "tcp set request",
    "x": 340,
    "y": 80,
    "wires": [
      [
        "f7b77fa8.c2f88"
      ]
    ]
  },
  {
    "id": "8f0eb1ed.19dea",
    "type": "function",
    "z": "75994a9b.4846ac",
    "name": "create request",
    "func": "msg.payload = `SET ${msg.deviceId} ${msg.value}`;\n\nswitch(msg.device) {\n    case \"shelf\" : msg.port = 9090; break;\n    case \"cart\" : msg.port = 9091; break;\n    case \"totem\" : msg.port = 9092; break;\n    default: msg.port = 0;\n}\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 160,
    "y": 80,
    "wires": [
      [
        "9e926b17.bf9b5"
      ]
    ]
  },
  {
    "id": "97546f0b.21e3a",
    "type": "subflow:75994a9b.4846ac",
    "z": "11b01065.87c36",
    "name": "",
    "x": 760,
    "y": 120,
    "wires": [
      [
        "e1f6b66.98aff48"
      ]
    ]
  },
  {
    "id": "2db8164c.4d9fda",
    "type": "inject",
    "z": "11b01065.87c36",
    "name": "thermostat frequence",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "repeat": "1",
    "crontab": "",
    "once": false,
    "x": 160,
    "y": 180,
    "wires": [
      [
        "f00043a8.e5bba"
      ]
    ]
  },
  {
    "id": "8373c38a.1aff38",
    "type": "tcp request",
    "z": "9764201b.6e44f8",
    "server": "localhost",
    "port": "",
    "out": "time",
    "splitc": "0",
    "name": "tcp get request",
    "x": 340,
    "y": 80,
    "wires": [
      [
        "e662febb.30f3f8"
      ]
    ]
  },
  {
    "id": "bb3021cf.9d2418",
    "type": "function",
    "z": "9764201b.6e44f8",
    "name": "create request",
    "func": "msg.payload = `GET ${msg.deviceId}`;\n\nswitch(msg.device) {\n    case \"shelf\" : msg.port = 9090; break;\n    case \"cart\" : msg.port = 9091; break;\n    case \"totem\" : msg.port = 9092; break;\n    default: msg.port = 0;\n}\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 160,
    "y": 80,
    "wires": [
      [
        "8373c38a.1aff38"
      ]
    ]
  },
  {
    "id": "8b9591cd.db2128",
    "type": "subflow:9764201b.6e44f8",
    "z": "11b01065.87c36",
    "name": "",
    "x": 380,
    "y": 230,
    "wires": [
      [
        "a5a8da7d.d083a"
      ]
    ]
  },
  {
    "id": "f00043a8.e5bba",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "generate get request",
    "func": "msg = {};\nmsg.device = \"shelf\";\nmsg.deviceId = \"S1_Temp\";\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 160,
    "y": 230,
    "wires": [
      [
        "8b9591cd.db2128"
      ]
    ]
  },
  {
    "id": "a5a8da7d.d083a",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "adjust temperature",
    "func": "function getAdjustment(preferred, actual) {\n    var adj = 0.0;\n    if (actual < preferred) {\n      adj = 0.1;\n    } else if (actual > preferred) {\n      adj = -0.1;\n    }\n    return (actual + adj).toFixed(1);\n}\nvar value = parseFloat(msg.value);\nmsg = {};\nmsg.device = \"shelf\";\nmsg.deviceId = \"S1_Temp\";\nmsg.value = getAdjustment(2, value);\nmsg.payload = `Adjust temperature to ${msg.value}`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 590,
    "y": 230,
    "wires": [
      [
        "97546f0b.21e3a"
      ]
    ]
  },
  {
    "id": "e662febb.30f3f8",
    "type": "function",
    "z": "9764201b.6e44f8",
    "name": "output",
    "func": "msg.payload = `${msg.payload}`;\narray = msg.payload.split(\" \");\n\nmsg.responseStatus = array[0];\nif (msg.responseStatus === \"ERROR\") {\n    msg.errorCode = parseInt(array[1]);\n    msg.errorMessage = array.slice(2).join(\" \");\n    node.error(\"Error\", msg);\n}\n\nif (msg.responseStatus === \"OK\") {\n    msg.deviceId = array[1];\n    msg.value = array[2];\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 510,
    "y": 80,
    "wires": [
      []
    ]
  },
  {
    "id": "f7b77fa8.c2f88",
    "type": "function",
    "z": "75994a9b.4846ac",
    "name": "output",
    "func": "msg.payload = `${msg.payload}`;\narray = msg.payload.split(\" \");\n\nmsg.responseStatus = array[0];\nif (msg.responseStatus === \"ERROR\") {\n    msg.errorCode = parseInt(array[1]);\n    msg.errorMessage = array.slice(2).join(\" \");\n    node.error(\"Error\", msg);\n}\n\nif (msg.responseStatus === \"OK\") {\n    msg.deviceId = array[1];\n    msg.value = array[2];\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 510,
    "y": 80,
    "wires": [
      []
    ]
  },
  {
    "id": "9aa1207c.92a858",
    "type": "catch",
    "z": "75994a9b.4846ac",
    "name": "Catch output errors",
    "scope": [
      "f7b77fa8.c2f88"
    ],
    "x": 550,
    "y": 140,
    "wires": [
      [
        "4d6e7492.fac554"
      ]
    ]
  },
  {
    "id": "4d6e7492.fac554",
    "type": "debug",
    "z": "75994a9b.4846ac",
    "name": "Show errors",
    "active": true,
    "console": "true",
    "complete": "true",
    "x": 820,
    "y": 140,
    "wires": []
  },
  {
    "id": "993da07e.59b0e8",
    "type": "catch",
    "z": "9764201b.6e44f8",
    "name": "Catch output errors",
    "scope": [
      "e662febb.30f3f8"
    ],
    "x": 550,
    "y": 140,
    "wires": [
      [
        "f0f56451.44e098"
      ]
    ]
  },
  {
    "id": "f0f56451.44e098",
    "type": "debug",
    "z": "9764201b.6e44f8",
    "name": "Show errors",
    "active": true,
    "console": "true",
    "complete": "true",
    "x": 820,
    "y": 140,
    "wires": []
  },
  {
    "id": "68ddd92.8244b28",
    "type": "ui_chart",
    "z": "11b01065.87c36",
    "name": "",
    "group": "fd9e676c.85fd6",
    "order": 0,
    "width": "12",
    "height": "6",
    "label": "chart",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "-1",
    "ymax": "6",
    "removeOlder": "5",
    "removeOlderPoints": "",
    "removeOlderUnit": "60",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "useOldStyle": false,
    "x": 960,
    "y": 230,
    "wires": [
      [],
      []
    ]
  },
  {
    "id": "e1f6b66.98aff48",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "Convert result value",
    "func": "var value = parseFloat(msg.value);\nmsg = {};\nmsg.payload = value;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 850,
    "y": 180,
    "wires": [
      [
        "68ddd92.8244b28"
      ]
    ]
  },
  {
    "id": "159861f5.55a226",
    "type": "comment",
    "z": "11b01065.87c36",
    "name": "Temperature management",
    "info": "",
    "x": 130,
    "y": 60,
    "wires": []
  },
  {
    "id": "2881b278.ca7586",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "generate get removed request",
    "func": "var index = context.get(\"deviceIndex\")||0;\nindex = (index % 5) + 1;\ncontext.set(\"deviceIndex\", index);\n\nmsg = {};\nmsg.device = \"shelf\";\nmsg.deviceId = `S${index}_Rem`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 580,
    "y": 480,
    "wires": [
      [
        "bcff46a7.06c658"
      ]
    ]
  },
  {
    "id": "7c9fb129.f87b9",
    "type": "comment",
    "z": "11b01065.87c36",
    "name": "Products in shelves management",
    "info": "",
    "x": 160,
    "y": 350,
    "wires": []
  },
  {
    "id": "8275e4b6.c8e3d",
    "type": "mongodb2 in",
    "z": "1c278488.7d6afb",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "products",
    "operation": "",
    "x": 460,
    "y": 100,
    "wires": [
      [
        "45f52ab9.46c1c4"
      ]
    ]
  },
  {
    "id": "6035985e.0b62e",
    "type": "function",
    "z": "1c278488.7d6afb",
    "name": "format result",
    "func": "var deviceId = msg.shelf;\nvar value = msg.value;\nvar availability = msg.amount;\n\nmsg = {};\nmsg.deviceId = deviceId;\nmsg.value = value;\nmsg.availability = availability;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 850,
    "y": 200,
    "wires": [
      []
    ]
  },
  {
    "id": "97df9e3d.1f581",
    "type": "inject",
    "z": "11b01065.87c36",
    "name": "Shelf check frequence",
    "topic": "",
    "payload": "true",
    "payloadType": "bool",
    "repeat": "1",
    "crontab": "",
    "once": false,
    "x": 160,
    "y": 440,
    "wires": [
      [
        "d9086e.221b379",
        "2881b278.ca7586"
      ]
    ]
  },
  {
    "id": "b6f3b481.63c228",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "generate get added request",
    "func": "var index = context.get(\"deviceIndex\")||0;\nindex = (index % 5) + 1;\ncontext.set(\"deviceIndex\", index);\n\nmsg = {};\nmsg.device = \"shelf\";\nmsg.deviceId = `S${index}_Add`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 590,
    "y": 400,
    "wires": [
      [
        "bcff46a7.06c658"
      ]
    ]
  },
  {
    "id": "bcff46a7.06c658",
    "type": "subflow:9764201b.6e44f8",
    "z": "11b01065.87c36",
    "name": "",
    "x": 870,
    "y": 440,
    "wires": [
      [
        "4963073a.67a6b"
      ]
    ]
  },
  {
    "id": "4963073a.67a6b",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "Continue only if a product has been added or removed",
    "func": "msg.value = parseInt(msg.value);\n\nif (msg.value >= 0) {\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 280,
    "y": 620,
    "wires": [
      [
        "58731525.20ee64",
        "1419e0e3.ef14c7"
      ]
    ]
  },
  {
    "id": "58731525.20ee64",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "reset value",
    "func": "msg.value = -1;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 700,
    "y": 620,
    "wires": [
      [
        "2384c3ba.cb34dc"
      ]
    ]
  },
  {
    "id": "2384c3ba.cb34dc",
    "type": "subflow:75994a9b.4846ac",
    "z": "11b01065.87c36",
    "name": "",
    "x": 900,
    "y": 620,
    "wires": [
      []
    ]
  },
  {
    "id": "5dc37461.93b504",
    "type": "subflow:1c278488.7d6afb",
    "z": "11b01065.87c36",
    "name": "",
    "x": 470,
    "y": 690,
    "wires": [
      [
        "9fb89805.ae494"
      ]
    ]
  },
  {
    "id": "1419e0e3.ef14c7",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "generate operation",
    "func": "if (msg.deviceId.indexOf(\"_Add\") >= 0) {\n    msg.shelf = msg.deviceId.replace(\"_Add\",\"\");\n    msg.amount = +1;\n    return msg;\n}\n\nif (msg.deviceId.indexOf(\"_Rem\") >= 0) {\n    msg.shelf = msg.deviceId.replace(\"_Rem\",\"\");\n    msg.amount = -1;\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 200,
    "y": 690,
    "wires": [
      [
        "5dc37461.93b504"
      ]
    ]
  },
  {
    "id": "bf7f4322.4baca",
    "type": "function",
    "z": "1c278488.7d6afb",
    "name": "find product availability",
    "func": "msg.operation = \"findOne\";\nmsg.payload = [\n    {\n        index : msg.value\n    }, {\n        _id : 0,\n        availability : 1\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 210,
    "y": 100,
    "wires": [
      [
        "8275e4b6.c8e3d"
      ]
    ]
  },
  {
    "id": "45f52ab9.46c1c4",
    "type": "function",
    "z": "1c278488.7d6afb",
    "name": "generate updated amount",
    "func": "var availability = msg.payload.availability;\nvar oldAmount = availability.filter(a => a.shelf === msg.shelf)[0];\n\nmsg.action = oldAmount === undefined;\nmsg.amount = msg.amount +\n            (msg.action ? 0 : oldAmount.value);\n\nif (msg.amount < 0) {\n    node.error(`Invalid amount ${msg.amount}`);\n} else {\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 720,
    "y": 100,
    "wires": [
      [
        "b2d66fda.e8d138"
      ]
    ]
  },
  {
    "id": "56536d0c.a0017c",
    "type": "function",
    "z": "1c278488.7d6afb",
    "name": "update product availability",
    "func": "msg.operation = \"updateOne\";\nmsg.payload = [\n    {\n        index : msg.value,\n        availability : {\n            $elemMatch : {shelf : msg.shelf}\n        }\n    }, {\n        $set: {\n            \"availability.$.value\" : msg.amount\n        }\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 360,
    "y": 220,
    "wires": [
      [
        "c69854e0.e0749"
      ]
    ]
  },
  {
    "id": "c69854e0.e0749",
    "type": "mongodb2 in",
    "z": "1c278488.7d6afb",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "products",
    "operation": "",
    "x": 640,
    "y": 200,
    "wires": [
      [
        "6035985e.0b62e"
      ]
    ]
  },
  {
    "id": "b2d66fda.e8d138",
    "type": "switch",
    "z": "1c278488.7d6afb",
    "name": "",
    "property": "action",
    "propertyType": "msg",
    "rules": [
      {
        "t": "true"
      },
      {
        "t": "false"
      }
    ],
    "checkall": "true",
    "outputs": 2,
    "x": 150,
    "y": 200,
    "wires": [
      [
        "38280046.2f13c8"
      ],
      [
        "56536d0c.a0017c"
      ]
    ]
  },
  {
    "id": "38280046.2f13c8",
    "type": "function",
    "z": "1c278488.7d6afb",
    "name": "insert product availability",
    "func": "msg.operation = \"updateOne\";\nmsg.payload = [\n    {\n        index : msg.value\n    }, {\n        $push: {\n            availability : {\n                shelf : msg.shelf,\n                value : msg.amount\n            }\n        }\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 350,
    "y": 180,
    "wires": [
      [
        "c69854e0.e0749"
      ]
    ]
  },
  {
    "id": "99595bd4.afda88",
    "type": "catch",
    "z": "1c278488.7d6afb",
    "name": "Invalid amount",
    "scope": [
      "45f52ab9.46c1c4"
    ],
    "x": 680,
    "y": 40,
    "wires": [
      [
        "fe627179.fd8d98"
      ]
    ]
  },
  {
    "id": "fe627179.fd8d98",
    "type": "debug",
    "z": "1c278488.7d6afb",
    "name": "",
    "active": true,
    "console": "false",
    "complete": "true",
    "x": 870,
    "y": 40,
    "wires": []
  },
  {
    "id": "d9086e.221b379",
    "type": "delay",
    "z": "11b01065.87c36",
    "name": "",
    "pauseType": "delay",
    "timeout": "500",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 380,
    "y": 400,
    "wires": [
      [
        "b6f3b481.63c228"
      ]
    ]
  },
  {
    "id": "dbeb271b.500e88",
    "type": "mqtt out",
    "z": "11b01065.87c36",
    "name": "publish availability",
    "topic": "",
    "qos": "1",
    "retain": "true",
    "broker": "6c5f366c.b6c0f8",
    "x": 910,
    "y": 690,
    "wires": []
  },
  {
    "id": "9fb89805.ae494",
    "type": "function",
    "z": "11b01065.87c36",
    "name": "Create topic",
    "func": "msg.topic = `supermarket/${msg.value}/availability/${msg.deviceId}`;\nmsg.payload = {\n    product : msg.value,\n    shelf : msg.deviceId,\n    availability : msg.availability\n};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 720,
    "y": 690,
    "wires": [
      [
        "dbeb271b.500e88"
      ]
    ]
  },
  {
    "id": "14e15984.8bc376",
    "type": "http in",
    "z": "175c22d2.0ef64d",
    "name": "Manage Form",
    "url": "/managesupermarket",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 100,
    "y": 80,
    "wires": [
      [
        "73a34e6c.d68dd"
      ]
    ]
  },
  {
    "id": "c4a8c423.4be0b8",
    "type": "http response",
    "z": "175c22d2.0ef64d",
    "name": "HTTP response",
    "statusCode": "",
    "headers": {},
    "x": 810,
    "y": 160,
    "wires": []
  },
  {
    "id": "7c89b293.a65094",
    "type": "http response",
    "z": "175c22d2.0ef64d",
    "name": "HTTP response",
    "statusCode": "",
    "headers": {},
    "x": 930,
    "y": 230,
    "wires": []
  },
  {
    "id": "62cffaa8.98178c",
    "type": "function",
    "z": "175c22d2.0ef64d",
    "name": "Add ajax Url",
    "func": "msg.url = \"api/managesupermarket\";\nmsg.products = msg.payload;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 500,
    "y": 80,
    "wires": [
      [
        "894cdc9b.6c91c8"
      ]
    ]
  },
  {
    "id": "894cdc9b.6c91c8",
    "type": "template",
    "z": "175c22d2.0ef64d",
    "name": "js",
    "field": "payload.script",
    "fieldType": "msg",
    "format": "javascript",
    "syntax": "plain",
    "template": "$.extend($.expr[':'], {\n    'containsi': function(elem, i, match, array) {\n        return (elem.textContent || elem.innerText || '').toLowerCase()\n            .indexOf((match[3] || \"\").toLowerCase()) >= 0;\n    }\n});\n\n$(document).ready(function(e) {\n    $(\"form[ajax=true]\").submit(function(e) {\n        e.preventDefault(); //disativa azioni di default del bottone\n        var form_data = $(this).serialize(); //crea un json con i dati della form\n        var form_url = $(this).attr(\"action\"); //legge il parametro action\n        var form_method = $(this).attr(\"method\").toUpperCase(); //legge il parametro methos\n        $.ajax({\n            url: form_url,\n            type: form_method,\n            data: form_data,\n            cache: false,\n            success: function(returnhtml) {\n                $(\"#result\").html(returnhtml);\n            }\n        });\n    });\n    \n    $('.list-count').text($('#list .in').length + ' items');\n    $(\"#search-text\").keyup(function () {  \n        var searchTerm = $(\"#search-text\").val();\n        var searchSplit = \":containsi('\" + searchTerm.replace(/ /g, \"'):containsi('\") + \"')\";\n        \n        $(\"#list li\").not(searchSplit).addClass('hidden out').removeClass('in');\n        $(\"#list li\" + searchSplit).removeClass('hidden out').addClass('in');\n  \n        var jobCount = $('#list .in').length;\n        $('.list-count').text(jobCount + ' items');\n    \n        if(jobCount === 0) {\n            $('#list').addClass('empty');\n        } else {\n            $('#list').removeClass('empty');\n        }\n    });\n});",
    "output": "str",
    "x": 650,
    "y": 80,
    "wires": [
      [
        "cb4b61e3.0dc83"
      ]
    ]
  },
  {
    "id": "cb4b61e3.0dc83",
    "type": "template",
    "z": "175c22d2.0ef64d",
    "name": "css",
    "field": "payload.style",
    "fieldType": "msg",
    "format": "css",
    "syntax": "plain",
    "template": "body {\n    margin: 0 auto;\n    height: 100vh;\n    box-sizing: border-box;\n    padding: 50px;\n    font: 16px \"Lucida Grande\", Helvetica, Arial, sans-serif;\n    background: #f0f0f0;\n}\n\n.wrapper {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.list-wrap label {\n  float:left;\n  color:#00BDE8;\n}\n\n.list-count {\n  display: inline-block;\n}\n\nli {\n  transition-property: margin, background-color, border-color;\n  transition-duration: .4s, .2s, .2s;\n  transition-timing-function: ease-in-out, ease, ease;\n}\n\n.empty-item {\n  transition-property: opacity;\n  transition-duration: 0s;\n  transition-delay: 0s;\n  transition-timing-function: ease;\n}\n\n.empty .empty-item {\n  transition-property: opacity;\n  transition-duration: .2s;\n  transition-delay: .3s;\n  transition-timing-function: ease;\n}\n\n.hiding {\n  margin-left:-100%;\n  opacity:0.5;\n}\n\n.hidden {\n  display:none;\n}\n\n.form-container {\n  box-sizing: border-box;\n}\n\n.list-container {\n  box-sizing: border-box;\n  position: relative;\n  height: 100%;\n}\n\n.list-container input {\n    display: inline-block;\n}\n\nul {\n  overflow-y: scroll;\n  overflow-x: hidden;\n  padding:0;\n  position: absolute;\n  bottom: 0;\n  top: 30px;\n  right: 0;\n  left: 0;\n  display: flex;\n  flex-wrap: wrap;\n  flex-grow: 1;\n}\n\nli, .empty-item {\n  box-sizing: border-box;\n  margin: 5px;\n  padding: 10px;\n  border-radius: 5px;\n  list-style: none;\n  background-color: white;\n  border: 1px solid lightgrey;\n  width: 32%;\n  min-width: 400px;\n}\n\nli:hover {\n  background-color:#f9f9f9;\n  border-color:#00BDE8;\n}\n\n.product-id {\n    color: firebrick;\n    font-weight: bold;\n    display: block;\n}\n.product-department {\n    display: block;\n    text-overflow: ellipsis;\n    overflow: hidden;\n    white-space: nowrap;\n}\n.product-title {\n    display: block;\n    text-overflow: ellipsis;\n    overflow: hidden;\n    white-space: nowrap;\n}\n.product-price {\n    display: block;\n}\n.product-discount {\n    display: block;\n}\n\n.empty-item {\n  background:#fff;\n  color:#ddd;\n  font-style:italic;\n  border:none;\n  text-align:center;\n  visibility:hidden;\n  opacity:0;\n}\n\n.empty .empty-item {\n  opacity:1;\n  visibility:visible;\n}",
    "output": "str",
    "x": 650,
    "y": 120,
    "wires": [
      [
        "280cbaf6.d65e7e"
      ]
    ]
  },
  {
    "id": "280cbaf6.d65e7e",
    "type": "template",
    "z": "175c22d2.0ef64d",
    "name": "html",
    "field": "payload",
    "fieldType": "msg",
    "format": "html",
    "syntax": "mustache",
    "template": "<html>\n<head>\n    <title>Supermarket Manager</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n    <script>{{{payload.script}}}</script>\n</head>\n<body>\n  <div class=\"wrapper\">\n    <h1>Supermarket Manager</h1>\n    <div class=\"form-container\">\n        <div>\n            <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n                <input type=\"text\" name=\"id\" placeholder=\"Product ID\">\n                <input type=\"number\" name=\"price\" placeholder=\"Price\" step=\"0.01\">\n                <input type=\"submit\" value=\"Submit\">\n            </form>\n        </div>\n        <div class=\"output-div\">\n            <span class=\"feedback-output\" id=\"result\"></span>\n        </div>\n    </div>\n    <div class=\"list-container\">\n        <input type=\"text\" id=\"search-text\" placeholder=\"Search product\" class=\"search-box\">\n        <div class=\"list-count\"></div>\n        <ul id=\"list\">\n            {{#products}}\n            <li class=\"in\">\n                <span class=\"product-id\">Id: {{index}}</span>\n                <span class=\"product-price\">Original Price: {{price.original}} {{price.currency}}</span>\n                <span class=\"product-discount\">Discount Price: {{price.discount}} {{price.currency}}</span>\n                <span class=\"product-department\">{{department}}</span>\n                <span class=\"product-title\">{{title}}</span>\n            </li>\n            {{/products}}\n        </ul>\n    </div>\n  </div>\n</body>\n</html>",
    "output": "str",
    "x": 650,
    "y": 160,
    "wires": [
      [
        "c4a8c423.4be0b8"
      ]
    ]
  },
  {
    "id": "94c4dfd0.1ae0d",
    "type": "json",
    "z": "175c22d2.0ef64d",
    "name": "",
    "pretty": false,
    "x": 590,
    "y": 230,
    "wires": [
      [
        "64e9973c.4d7fc"
      ]
    ]
  },
  {
    "id": "64e9973c.4d7fc",
    "type": "function",
    "z": "175c22d2.0ef64d",
    "name": "Render Output",
    "func": "msg.payload = 'Data correcly transmitted: '+msg.payload;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 750,
    "y": 230,
    "wires": [
      [
        "7c89b293.a65094"
      ]
    ]
  },
  {
    "id": "db3c6bc2.2d6bd8",
    "type": "http in",
    "z": "175c22d2.0ef64d",
    "name": "Form Response",
    "url": "/api/managesupermarket",
    "method": "post",
    "upload": false,
    "swaggerDoc": "",
    "x": 110,
    "y": 230,
    "wires": [
      [
        "ea2da5a4.10451",
        "792be230.24e5e4"
      ]
    ]
  },
  {
    "id": "b445821a.a2f2b8",
    "type": "ui_template",
    "z": "186b7a65.42ec46",
    "group": "9d4a3a62.d7ce4",
    "name": "Carts current heatmap",
    "order": 0,
    "width": "10",
    "height": "12",
    "format": "<style>{{msg.style}}</style>\n<div id=\"grid\">\n    <h2>Current carts position</h2>\n    <table>\n        <tr ng-repeat=\"row in msg.currentGrid.grid track by $index\">\n            <td ng-repeat=\"cell in row track by $index\">\n                <div class=\"cell\" ng-class=\"{\n                    shelf: !Number.isInteger(cell) && cell.charAt(0) == 'S',\n                    totem: !Number.isInteger(cell) && cell.charAt(0) == 'T',\n                    q1: cell==1,\n                    q2: cell>1 && cell<=2,\n                    q3: cell>2 && cell<=3,\n                    q4: cell>3 && cell<=4,\n                    q5: cell>4\n                    }\">{{cell}}</div>\n            </td>\n        </tr>\n    </table>\n</div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "templateScope": "local",
    "x": 570,
    "y": 180,
    "wires": [
      []
    ]
  },
  {
    "id": "a3c80e19.fd71b",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "generate get cart position request",
    "func": "var index = context.get(\"deviceIndex\")||0;\nindex = (index+1) % 20;\ncontext.set(\"deviceIndex\", index);\n\nmsg = {};\nmsg.device = \"cart\";\nmsg.deviceId = `Cart_${index}`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 340,
    "y": 120,
    "wires": [
      [
        "646e5f7c.294ad"
      ]
    ]
  },
  {
    "id": "646e5f7c.294ad",
    "type": "subflow:9764201b.6e44f8",
    "z": "186b7a65.42ec46",
    "name": "",
    "x": 600,
    "y": 120,
    "wires": [
      [
        "d18c7dab.f45df8"
      ]
    ]
  },
  {
    "id": "d8a8d332.30672",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "update supermarket grids",
    "func": "/* \n * Workaround for class definition in node-red:\n * define the class inside a function with strict mode\n */\nfunction makeGrid(mongoGrid) {\n    \"use strict\";\n    class Grid {\n        constructor(mongoGrid) {\n            this.grid = [];\n            this.width = mongoGrid.width;\n            this.height = mongoGrid.height;\n            this.carts = {};\n            for (var y = 0; y < this.height; y++) {\n                this.grid[y] = [];\n                for (var x = 0; x < this.width; x++) {\n                    var cell = mongoGrid.grid[y][x];\n                    this.grid[y][x] = cell === \"\" ? 0 : cell;\n                }\n            }\n        }\n    \n        move(cartId, x, y) {\n            this.remove(cartId);\n            this.add(cartId,x,y);\n        }\n        \n        add(cartId, x, y) {\n            if (x < 0 || x >= this.width) {\n                throw new Error(`out of grid x ${x}`);\n            }\n            if (y < 0 || y >= this.height) {\n                throw new Error(`out of grid y ${y}`);\n            }\n            if (!Number.isInteger(this.grid[y][x])) {\n                throw new Error(`invalid position ${x},${y}`);\n            }\n            this.grid[y][x] += 1;\n            this.carts[cartId] = {x: x, y: y};\n        }\n    \n        remove(cartId) {\n            var oldPosition = this.carts[cartId];\n            if (typeof oldPosition !== \"undefined\") {\n                this.grid[oldPosition.y][oldPosition.x] -= 1;\n            }\n            this.carts[cartId] = undefined;\n        }\n    }\n    \n    return new Grid(mongoGrid);\n}\n\nvar currentGridKey = \"currentGrid\";\nvar cumulatedGridKey = \"cumulatedGrid\";\n\nvar currentGrid = context.get(currentGridKey);\nif (currentGrid === null || currentGrid === undefined) {\n    currentGrid = makeGrid(msg.payload);\n}\n\nvar cumulatedGrid = context.get(cumulatedGridKey);\nif (cumulatedGrid === null || cumulatedGrid === undefined) {\n    cumulatedGrid = makeGrid(msg.payload);\n}\n\nmsg.value = JSON.parse(msg.value);\nvar x = Math.floor(msg.value.x);\nvar y = Math.floor(msg.value.y);\ncurrentGrid.move(msg.deviceId, x, y);\ncumulatedGrid.add(msg.deviceId, x, y);\n\ncontext.set(currentGridKey, currentGrid);\ncontext.set(cumulatedGridKey, cumulatedGrid);\n\nmsg.currentGrid = currentGrid;\nmsg.cumulatedGrid = cumulatedGrid;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 190,
    "y": 210,
    "wires": [
      [
        "d834dc9d.2d209"
      ]
    ]
  },
  {
    "id": "785c63fb.1db7a4",
    "type": "comment",
    "z": "186b7a65.42ec46",
    "name": "Carts heatmap",
    "info": "",
    "x": 110,
    "y": 50,
    "wires": []
  },
  {
    "id": "c60fe722.612468",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "generate random cart positions",
    "func": "function isFreeCell(grid, width, height, x, y) {\n    var X = Math.floor(x);\n    var Y = Math.floor(y);\n    return X >= 0 && X < width && Y >= 0 && Y < height && grid[Y][X] === \"\";\n}\n\nfunction getNewPosition(oldPosition, grid, width, height) {\n    var maxTries = 0;\n    var newPosition = {};\n    do {\n        var speed = Math.random() * (Math.random() > 0.4 ? 1.3 : 2.2);\n        var angle = Math.random() * 2 * Math.PI;\n        var xAngle = (5 * Math.cos(angle) + oldPosition.xAngle) / 6;\n        var yAngle = (5 * Math.sin(angle) + oldPosition.yAngle) / 6;\n        \n        newPosition = {\n            x : oldPosition.x + (speed * xAngle),\n            y : oldPosition.y + (speed * yAngle),\n            xAngle : xAngle,\n            yAngle : yAngle\n        };\n        maxTries++;\n    } while (maxTries < 3 &&\n        !isFreeCell(grid, width, height, newPosition.x, newPosition.y));\n    \n    //rounding decimals\n    newPosition.x = Number(Math.round(newPosition.x + 'e2') + 'e-2');\n    newPosition.y = Number(Math.round(newPosition.y + 'e2') + 'e-2');\n    return newPosition;\n}\n\nvar indexKey = \"deviceIndex\";\nvar index = context.get(indexKey) || 0;\nindex = (index+1) % 20;\ncontext.set(indexKey, index);\n\nvar width = msg.payload.width;\nvar height = msg.payload.height;\nvar grid = msg.payload.grid;\n\nvar positionKey = `position_${index}`;\nvar oldPosition = context.get(positionKey) || {\n    x : Math.random() * width,\n    y : Math.random() * height,\n    xAngle : 0,\n    yAngle : 0\n};\n\nvar newPosition = getNewPosition(oldPosition, grid, width, height);\n    \nif (isFreeCell(grid, width, height, newPosition.x, newPosition.y)) {\n    msg = {};\n    msg.device = \"cart\";\n    msg.deviceId = `Cart_${index}`;\n    msg.value = `${newPosition.x},${newPosition.y}`;\n    context.set(positionKey, newPosition);\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 580,
    "y": 320,
    "wires": [
      [
        "55135180.94af78"
      ]
    ]
  },
  {
    "id": "55135180.94af78",
    "type": "subflow:75994a9b.4846ac",
    "z": "186b7a65.42ec46",
    "x": 840,
    "y": 320,
    "wires": [
      []
    ]
  },
  {
    "id": "36f1a4d5.84703c",
    "type": "mongodb2 in",
    "z": "821fa547.1b5ce8",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "map",
    "operation": "",
    "x": 480,
    "y": 70,
    "wires": [
      []
    ]
  },
  {
    "id": "92218ff1.234658",
    "type": "function",
    "z": "821fa547.1b5ce8",
    "name": "find product availability",
    "func": "msg.operation = \"findOne\"\nmsg.payload = [\n    {}, {}\n]\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 230,
    "y": 70,
    "wires": [
      [
        "36f1a4d5.84703c"
      ]
    ]
  },
  {
    "id": "3cb6c56e.3d9112",
    "type": "subflow:821fa547.1b5ce8",
    "z": "186b7a65.42ec46",
    "x": 310,
    "y": 320,
    "wires": [
      [
        "c60fe722.612468"
      ]
    ]
  },
  {
    "id": "d18c7dab.f45df8",
    "type": "subflow:821fa547.1b5ce8",
    "z": "186b7a65.42ec46",
    "x": 830,
    "y": 120,
    "wires": [
      [
        "d8a8d332.30672"
      ]
    ]
  },
  {
    "id": "97983c7e.ee6eb8",
    "type": "mongodb2 in",
    "z": "ca9d5af1.bc0ea8",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "products",
    "operation": "",
    "x": 460,
    "y": 60,
    "wires": [
      []
    ]
  },
  {
    "id": "36cb8568.df137a",
    "type": "function",
    "z": "ca9d5af1.bc0ea8",
    "name": "find all product",
    "func": "msg.operation = \"find.toArray\"\nmsg.payload = [{}, {_id:false}];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 220,
    "y": 60,
    "wires": [
      [
        "97983c7e.ee6eb8"
      ]
    ]
  },
  {
    "id": "73a34e6c.d68dd",
    "type": "subflow:ca9d5af1.bc0ea8",
    "z": "175c22d2.0ef64d",
    "name": "",
    "x": 300,
    "y": 80,
    "wires": [
      [
        "62cffaa8.98178c"
      ]
    ]
  },
  {
    "id": "6fe7e765.9bc12",
    "type": "mongodb2 in",
    "z": "6306fa17.2370dc",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "products",
    "operation": "",
    "x": 540,
    "y": 80,
    "wires": [
      []
    ]
  },
  {
    "id": "afc44443.15a23",
    "type": "function",
    "z": "6306fa17.2370dc",
    "name": "update discount",
    "func": "var id = parseInt(msg.payload.id);\nvar price = parseFloat(msg.payload.price);\nmsg.operation = \"updateOne\";\nmsg.payload = [\n    {\n        'index' : id\n    }, {\n       $set: {\n           'price.discount': price\n        } \n    }\n]  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 220,
    "y": 80,
    "wires": [
      [
        "6fe7e765.9bc12"
      ]
    ]
  },
  {
    "id": "ea2da5a4.10451",
    "type": "subflow:6306fa17.2370dc",
    "z": "175c22d2.0ef64d",
    "name": "",
    "x": 410,
    "y": 230,
    "wires": [
      [
        "94c4dfd0.1ae0d"
      ]
    ]
  },
  {
    "id": "d834dc9d.2d209",
    "type": "template",
    "z": "186b7a65.42ec46",
    "name": "map style",
    "field": "style",
    "fieldType": "msg",
    "format": "css",
    "syntax": "plain",
    "template": "#grid table {\n    border-collapse: collapse;\n    border-spacing: 0;\n}\n#grid .cell {\n    color: black;\n    width: 45px;\n    height: 45px;\n    text-align: center;\n    line-height: 40px;\n    padding: 2px;\n    box-sizing: border-box;\n    border: 1px dashed grey;\n    background: rgb(240,240,240);\n    margin: 0;\n}\n#grid .cell.shelf {\n    border: 1px solid rgb(40,40,180);\n    background: rgb(40,40,180);\n    color: white;\n    font-weight: bold;\n}\n#grid .cell.totem {\n    background: white;\n    color: grey;\n    font-weight: bold;\n}\n#grid .cell.q1 {\n    background: rgb(5,245,5);\n}\n#grid .cell.q2 {\n    background: rgb(150,245,5);\n}\n#grid .cell.q3 {\n    background: rgb(245,245,5);\n}\n#grid .cell.q4 {\n    background: rgb(245,140,5);\n}\n#grid .cell.q5 {\n    background: rgb(245,5,5);\n}",
    "output": "str",
    "x": 380,
    "y": 210,
    "wires": [
      [
        "b445821a.a2f2b8",
        "1d567015.9722f8"
      ]
    ]
  },
  {
    "id": "1d567015.9722f8",
    "type": "ui_template",
    "z": "186b7a65.42ec46",
    "group": "9d4a3a62.d7ce4",
    "name": "Carts cumulated heatmap",
    "order": 0,
    "width": "10",
    "height": "12",
    "format": "<style>{{msg.style}}</style>\n<div id=\"grid\">\n    <h2>Cumulated carts position</h2>\n    <table>\n        <tr ng-repeat=\"row in msg.cumulatedGrid.grid track by $index\">\n            <td ng-repeat=\"cell in row track by $index\">\n                <div class=\"cell\" ng-class=\"{\n                    shelf: !Number.isInteger(cell) && cell.charAt(0) == 'S',\n                    totem: !Number.isInteger(cell) && cell.charAt(0) == 'T',\n                    q1: cell==1,\n                    q2: cell>1 && cell<=8,\n                    q3: cell>8 && cell<=16,\n                    q4: cell>16 && cell<=30,\n                    q5: cell>30\n                    }\">{{cell}}</div>\n            </td>\n        </tr>\n    </table>\n</div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "templateScope": "local",
    "x": 590,
    "y": 240,
    "wires": [
      []
    ]
  },
  {
    "id": "27185bc8.62921c",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "check product removed from cart",
    "func": "var indexKey = \"deviceIndex\";\nvar index = context.get(indexKey) || 0;\nindex = (index+1) % 20;\ncontext.set(indexKey, index);\n\nmsg = {};\nmsg.device = \"cart\";\nmsg.deviceId = `Cart_${index}_Rem`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 490,
    "y": 590,
    "wires": [
      [
        "aec71f0f.0374b8"
      ]
    ]
  },
  {
    "id": "99fefb4f.f3bf18",
    "type": "comment",
    "z": "186b7a65.42ec46",
    "name": "Products in carts management",
    "info": "",
    "x": 160,
    "y": 450,
    "wires": []
  },
  {
    "id": "e5c047da.9b7fb8",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "check product added to cart",
    "func": "var indexKey = \"deviceIndex\";\nvar index = context.get(indexKey) || 0;\nindex = (index+1) % 20;\ncontext.set(indexKey, index);\n\nmsg = {};\nmsg.device = \"cart\";\nmsg.deviceId = `Cart_${index}_Add`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 510,
    "y": 510,
    "wires": [
      [
        "aec71f0f.0374b8"
      ]
    ]
  },
  {
    "id": "aec71f0f.0374b8",
    "type": "subflow:9764201b.6e44f8",
    "z": "186b7a65.42ec46",
    "name": "",
    "x": 770,
    "y": 550,
    "wires": [
      [
        "b5b89516.618f9"
      ]
    ]
  },
  {
    "id": "b5b89516.618f9",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "Continue only if a product has been added or removed",
    "func": "msg.value = parseInt(msg.value);\n\nif (msg.value >= 0) {\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 280,
    "y": 690,
    "wires": [
      [
        "7e8abd80.f5bc94",
        "692a1450.4013d4"
      ]
    ]
  },
  {
    "id": "7e8abd80.f5bc94",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "reset value",
    "func": "msg.value = -1;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 680,
    "y": 690,
    "wires": [
      [
        "3fc731af.9c0726"
      ]
    ]
  },
  {
    "id": "3fc731af.9c0726",
    "type": "subflow:75994a9b.4846ac",
    "z": "186b7a65.42ec46",
    "name": "",
    "x": 880,
    "y": 690,
    "wires": [
      []
    ]
  },
  {
    "id": "692a1450.4013d4",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "generate operation",
    "func": "if (msg.deviceId.indexOf(\"_Add\") >= 0) {\n    msg.cart = msg.deviceId.replace(\"_Add\",\"\");\n    msg.amount = +1;\n    return msg;\n}\n\nif (msg.deviceId.indexOf(\"_Rem\") >= 0) {\n    msg.cart = msg.deviceId.replace(\"_Rem\",\"\");\n    msg.amount = -1;\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 610,
    "y": 760,
    "wires": [
      [
        "86d5aecf.400a58"
      ]
    ]
  },
  {
    "id": "c3580646.196f4",
    "type": "delay",
    "z": "186b7a65.42ec46",
    "name": "",
    "pauseType": "delay",
    "timeout": "125",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 280,
    "y": 510,
    "wires": [
      [
        "e5c047da.9b7fb8"
      ]
    ]
  },
  {
    "id": "64646f7a.f0b79",
    "type": "inject",
    "z": "9cddb094.21ea78",
    "name": "Every second",
    "topic": "",
    "payload": "true",
    "payloadType": "bool",
    "repeat": "1",
    "crontab": "",
    "once": false,
    "x": 130,
    "y": 90,
    "wires": [
      [
        "24f191ba.f9637e",
        "723021e6.3065a8",
        "67ce8bb5.4a9d84"
      ]
    ]
  },
  {
    "id": "24f191ba.f9637e",
    "type": "delay",
    "z": "9cddb094.21ea78",
    "name": "",
    "pauseType": "delay",
    "timeout": "500",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 370,
    "y": 70,
    "wires": [
      []
    ]
  },
  {
    "id": "723021e6.3065a8",
    "type": "delay",
    "z": "9cddb094.21ea78",
    "name": "",
    "pauseType": "delay",
    "timeout": "250",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 370,
    "y": 110,
    "wires": [
      []
    ]
  },
  {
    "id": "67ce8bb5.4a9d84",
    "type": "delay",
    "z": "9cddb094.21ea78",
    "name": "",
    "pauseType": "delay",
    "timeout": "750",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 370,
    "y": 40,
    "wires": [
      []
    ]
  },
  {
    "id": "287d1b1f.cdc8a4",
    "type": "subflow:9cddb094.21ea78",
    "z": "186b7a65.42ec46",
    "x": 100,
    "y": 120,
    "wires": [
      [
        "a3c80e19.fd71b"
      ]
    ]
  },
  {
    "id": "1d828ca3.dca29b",
    "type": "subflow:9cddb094.21ea78",
    "z": "186b7a65.42ec46",
    "x": 100,
    "y": 320,
    "wires": [
      [
        "3cb6c56e.3d9112"
      ]
    ]
  },
  {
    "id": "5c8dd8ec.81d308",
    "type": "subflow:9cddb094.21ea78",
    "z": "186b7a65.42ec46",
    "x": 100,
    "y": 550,
    "wires": [
      [
        "c3580646.196f4",
        "27185bc8.62921c"
      ]
    ]
  },
  {
    "id": "f03dfaae.0c05d8",
    "type": "comment",
    "z": "175c22d2.0ef64d",
    "name": "Update prices",
    "info": "",
    "x": 100,
    "y": 30,
    "wires": []
  },
  {
    "id": "bc180993.6dd38",
    "type": "mongodb2 in",
    "z": "cc688324.604068",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Carts collection",
    "collection": "carts",
    "operation": "",
    "x": 400,
    "y": 110,
    "wires": [
      [
        "814ee560.71d878"
      ]
    ]
  },
  {
    "id": "86d5aecf.400a58",
    "type": "subflow:cc688324.604068",
    "z": "186b7a65.42ec46",
    "x": 850,
    "y": 760,
    "wires": [
      []
    ]
  },
  {
    "id": "489d6e02.f26a9",
    "type": "function",
    "z": "cc688324.604068",
    "name": "format result",
    "func": "var deviceId = msg.cart;\nvar productId = msg.value;\nvar amount = msg.amount;\n\nmsg = {};\nmsg.deviceId = deviceId;\nmsg.productId = productId;\nmsg.amount = amount;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 800,
    "y": 260,
    "wires": [
      []
    ]
  },
  {
    "id": "cbeb4b03.74f648",
    "type": "function",
    "z": "cc688324.604068",
    "name": "find product amount",
    "func": "msg.operation = \"findOne\";\nmsg.payload = [\n    {\n        cart : msg.cart,\n    }, {\n        _id : 0,\n        products : 1\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 190,
    "y": 110,
    "wires": [
      [
        "bc180993.6dd38"
      ]
    ]
  },
  {
    "id": "814ee560.71d878",
    "type": "function",
    "z": "cc688324.604068",
    "name": "generate updated amount",
    "func": "if (msg.payload === null) {\n    msg.action = \"insert\";\n} else {\n    var products = msg.payload.products;\n    var product = products.filter(p => p.index === msg.value)[0];\n\n    msg.action = product === undefined ? \"upsert\" : \"update\";\n    msg.amount = msg.amount +\n                (msg.action === \"upsert\" ? 0 : product.amount);\n}\n\nif (msg.amount < 0) {\n    node.error(`Invalid amount ${msg.amount}`);\n} else {\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 640,
    "y": 110,
    "wires": [
      [
        "9e6cdd98.6808e8"
      ]
    ]
  },
  {
    "id": "366ee8a9.a1733",
    "type": "function",
    "z": "cc688324.604068",
    "name": "update product amount",
    "func": "msg.operation = \"updateOne\";\nmsg.payload = [\n    {\n        cart : msg.cart,\n        products : {\n            $elemMatch : {index : msg.value}\n        }\n    }, {\n        $set: {\n            \"products.$.amount\" : msg.amount\n        }\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 370,
    "y": 300,
    "wires": [
      [
        "bfe31264.184f6"
      ]
    ]
  },
  {
    "id": "9e6cdd98.6808e8",
    "type": "switch",
    "z": "cc688324.604068",
    "name": "",
    "property": "action",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "insert",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "upsert",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "update",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "outputs": 3,
    "x": 160,
    "y": 260,
    "wires": [
      [
        "ee9bed23.0bcaf"
      ],
      [
        "63df1b07.a56aec"
      ],
      [
        "366ee8a9.a1733"
      ]
    ]
  },
  {
    "id": "63df1b07.a56aec",
    "type": "function",
    "z": "cc688324.604068",
    "name": "upsert product amount",
    "func": "msg.operation = \"updateOne\";\nmsg.payload = [\n    {\n        cart : msg.cart\n    }, {\n        $push: {\n            products : {\n                index : msg.value,\n                amount : msg.amount\n            }\n        }\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 370,
    "y": 260,
    "wires": [
      [
        "bfe31264.184f6"
      ]
    ]
  },
  {
    "id": "f1f31fd2.036b9",
    "type": "catch",
    "z": "cc688324.604068",
    "name": "Invalid amount",
    "scope": [
      "814ee560.71d878"
    ],
    "x": 600,
    "y": 60,
    "wires": [
      [
        "a203526.03e5db"
      ]
    ]
  },
  {
    "id": "a203526.03e5db",
    "type": "debug",
    "z": "cc688324.604068",
    "name": "",
    "active": true,
    "console": "false",
    "complete": "true",
    "x": 790,
    "y": 60,
    "wires": []
  },
  {
    "id": "bfe31264.184f6",
    "type": "mongodb2 in",
    "z": "cc688324.604068",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Carts collection",
    "collection": "carts",
    "operation": "",
    "x": 610,
    "y": 260,
    "wires": [
      [
        "489d6e02.f26a9"
      ]
    ]
  },
  {
    "id": "ee9bed23.0bcaf",
    "type": "function",
    "z": "cc688324.604068",
    "name": "insert product amount",
    "func": "msg.operation = \"insertOne\";\nmsg.payload = [\n    {\n        cart : msg.cart,\n        products : [{\n            index : msg.value,\n            amount : msg.amount\n        }]\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 360,
    "y": 220,
    "wires": [
      [
        "bfe31264.184f6"
      ]
    ]
  },
  {
    "id": "1a5b611c.2e7a7f",
    "type": "comment",
    "z": "e2590d70.33a478",
    "name": "Detect products passing totems",
    "info": "",
    "x": 150,
    "y": 50,
    "wires": []
  },
  {
    "id": "cf01f67f.eaf79",
    "type": "inject",
    "z": "e2590d70.33a478",
    "name": "Totem check frequence",
    "topic": "",
    "payload": "true",
    "payloadType": "bool",
    "repeat": "1",
    "crontab": "",
    "once": false,
    "x": 160,
    "y": 140,
    "wires": [
      [
        "1f5a7a3.729ff06",
        "43afe96a.53d618"
      ]
    ]
  },
  {
    "id": "43afe96a.53d618",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "generate get added request",
    "func": "var index = context.get(\"deviceIndex\")||0;\nindex = (index % 2) + 1;\ncontext.set(\"deviceIndex\", index);\n\nmsg = {};\nmsg.device = \"totem\";\nmsg.deviceId = `T${index}_Detector`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 610,
    "y": 140,
    "wires": [
      [
        "b4bd9f92.da044"
      ]
    ]
  },
  {
    "id": "b4bd9f92.da044",
    "type": "subflow:9764201b.6e44f8",
    "z": "e2590d70.33a478",
    "name": "",
    "x": 870,
    "y": 140,
    "wires": [
      [
        "2403a5b4.2e9502"
      ]
    ]
  },
  {
    "id": "2403a5b4.2e9502",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "Continue only if a product has passed the totem",
    "func": "msg.value = parseInt(msg.value);\n\nif (msg.value >= 0) {\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "x": 250,
    "y": 270,
    "wires": [
      [
        "c47d782c.809bb8",
        "b5c2ca67.5c2ad",
        "a923d40c.4d01f8"
      ]
    ]
  },
  {
    "id": "2a6be54f.1d8512",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "reset value",
    "func": "msg.value = -1;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 710,
    "y": 270,
    "wires": [
      [
        "e3977844.f45528"
      ]
    ]
  },
  {
    "id": "e3977844.f45528",
    "type": "subflow:75994a9b.4846ac",
    "z": "e2590d70.33a478",
    "name": "",
    "x": 900,
    "y": 270,
    "wires": [
      []
    ]
  },
  {
    "id": "c47d782c.809bb8",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "Start alarm",
    "func": "msg.deviceId = msg.deviceId.replace(\"_Detector\", \"_Alarm\");\nmsg.value = true;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 190,
    "y": 370,
    "wires": [
      [
        "21be7d44.c57562"
      ]
    ]
  },
  {
    "id": "1f5a7a3.729ff06",
    "type": "delay",
    "z": "e2590d70.33a478",
    "name": "",
    "pauseType": "delay",
    "timeout": "500",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 380,
    "y": 120,
    "wires": [
      [
        "43afe96a.53d618"
      ]
    ]
  },
  {
    "id": "21be7d44.c57562",
    "type": "subflow:75994a9b.4846ac",
    "z": "e2590d70.33a478",
    "name": "",
    "x": 380,
    "y": 370,
    "wires": [
      [
        "96ecea79.e8749"
      ]
    ]
  },
  {
    "id": "e047f585.d7232",
    "type": "mqtt out",
    "z": "e2590d70.33a478",
    "name": "publish thefts",
    "topic": "",
    "qos": "2",
    "retain": "false",
    "broker": "6c5f366c.b6c0f8",
    "x": 920,
    "y": 320,
    "wires": []
  },
  {
    "id": "b5c2ca67.5c2ad",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "Create topic",
    "func": "var device = msg.deviceId.replace(\"_Detector\",\"\");\nmsg.topic = `supermarket/alarm/${device}`;\nmsg.payload = `${new Date().toISOString()} - Possible theft on totem ${device}`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 550,
    "y": 320,
    "wires": [
      [
        "e047f585.d7232"
      ]
    ]
  },
  {
    "id": "a923d40c.4d01f8",
    "type": "delay",
    "z": "e2590d70.33a478",
    "name": "",
    "pauseType": "delay",
    "timeout": "500",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 550,
    "y": 270,
    "wires": [
      [
        "2a6be54f.1d8512"
      ]
    ]
  },
  {
    "id": "96ecea79.e8749",
    "type": "delay",
    "z": "e2590d70.33a478",
    "name": "",
    "pauseType": "delay",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "x": 560,
    "y": 370,
    "wires": [
      [
        "6633c02e.a92d1"
      ]
    ]
  },
  {
    "id": "6633c02e.a92d1",
    "type": "function",
    "z": "e2590d70.33a478",
    "name": "Stop alarm",
    "func": "msg.value = false;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 710,
    "y": 370,
    "wires": [
      [
        "4f3cd48e.7603b4"
      ]
    ]
  },
  {
    "id": "4f3cd48e.7603b4",
    "type": "subflow:75994a9b.4846ac",
    "z": "e2590d70.33a478",
    "name": "",
    "x": 900,
    "y": 370,
    "wires": [
      []
    ]
  },
  {
    "id": "2987129.e504b6e",
    "type": "mongodb2 in",
    "z": "e5049f4c.fd313",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Shelves products collection",
    "collection": "products",
    "operation": "",
    "x": 470,
    "y": 70,
    "wires": [
      []
    ]
  },
  {
    "id": "5d3b2b89.9533c4",
    "type": "function",
    "z": "e5049f4c.fd313",
    "name": "find product by id",
    "func": "msg.operation = \"findOne\"\nvar id = parseInt(msg.payload.id);\nmsg.payload = [\n    {'index': id}, \n    {'_id':false}\n];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 220,
    "y": 70,
    "wires": [
      [
        "2987129.e504b6e"
      ]
    ]
  },
  {
    "id": "8b235d9f.34bc08",
    "type": "subflow:e5049f4c.fd313",
    "z": "175c22d2.0ef64d",
    "name": "",
    "x": 470,
    "y": 290,
    "wires": [
      [
        "eacfd7f7.36eca8"
      ]
    ]
  },
  {
    "id": "eacfd7f7.36eca8",
    "type": "function",
    "z": "175c22d2.0ef64d",
    "name": "create topic name and message",
    "func": "var product = msg.payload;\nvar department = product['department']\nmsg.topic = 'clients/' + department;\n\nvar title = product['title'];\nvar newPrice = msg.updatedPrice.toFixed(2) + product['price']['currency'];\nmsg.payload = title + \" -> \" + newPrice;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 750,
    "y": 290,
    "wires": [
      [
        "8ad1213.e73f4e"
      ]
    ]
  },
  {
    "id": "8ad1213.e73f4e",
    "type": "mqtt out",
    "z": "175c22d2.0ef64d",
    "name": "",
    "topic": "",
    "qos": "",
    "retain": "",
    "broker": "6c5f366c.b6c0f8",
    "x": 960,
    "y": 290,
    "wires": []
  },
  {
    "id": "891a94e2.4392a",
    "type": "comment",
    "z": "186b7a65.42ec46",
    "name": "Payment screen",
    "info": "",
    "x": 110,
    "y": 850,
    "wires": []
  },
  {
    "id": "fe0222c9.71f7e8",
    "type": "http in",
    "z": "186b7a65.42ec46",
    "name": "Get products in cart",
    "url": "/cart/:cart",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 120,
    "y": 940,
    "wires": [
      [
        "3ea67974.a062ce"
      ]
    ]
  },
  {
    "id": "3ea67974.a062ce",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "Check cart id",
    "func": "var cart = parseInt(msg.req.params.cart);\nmsg.wrongId = isNaN(cart) || cart < 0 || cart > 20;\nmsg.cart = cart;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 310,
    "y": 940,
    "wires": [
      [
        "746a5c6a.81aecc"
      ]
    ]
  },
  {
    "id": "32f74ac6.c7b38e",
    "type": "http response",
    "z": "186b7a65.42ec46",
    "name": "",
    "statusCode": "404",
    "headers": {},
    "x": 720,
    "y": 910,
    "wires": []
  },
  {
    "id": "e6de9755.a7b94",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "generate operation",
    "func": "msg.cart = `Cart_${msg.cart}`;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 620,
    "y": 970,
    "wires": [
      [
        "c62a367e.c72668"
      ]
    ]
  },
  {
    "id": "bba200a8.a8a65",
    "type": "http response",
    "z": "186b7a65.42ec46",
    "name": "",
    "statusCode": "",
    "headers": {},
    "x": 710,
    "y": 1120,
    "wires": []
  },
  {
    "id": "97f5cd3d.99b9a8",
    "type": "mongodb2 in",
    "z": "54963c28.722b74",
    "service": "_ext_",
    "configNode": "d8a581dc.b0cfa8",
    "name": "Carts collection",
    "collection": "carts",
    "operation": "",
    "x": 310,
    "y": 90,
    "wires": [
      [
        "837d76c6.49a3f"
      ]
    ]
  },
  {
    "id": "9c8f8645.4ea7d8",
    "type": "function",
    "z": "54963c28.722b74",
    "name": "find cart",
    "func": "msg.operation = \"findOne\";\nmsg.payload = [\n    {\n        cart : msg.cart,\n    }, {\n        _id : 0\n    }\n];  \nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 150,
    "y": 90,
    "wires": [
      [
        "97f5cd3d.99b9a8"
      ]
    ]
  },
  {
    "id": "c62a367e.c72668",
    "type": "subflow:54963c28.722b74",
    "z": "186b7a65.42ec46",
    "name": "",
    "x": 860,
    "y": 970,
    "wires": [
      [
        "f7aba048.0fdbd"
      ]
    ]
  },
  {
    "id": "792be230.24e5e4",
    "type": "function",
    "z": "175c22d2.0ef64d",
    "name": "Save updated price",
    "func": "msg.updatedPrice = parseFloat(msg.payload.price);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 240,
    "y": 290,
    "wires": [
      [
        "8b235d9f.34bc08"
      ]
    ]
  },
  {
    "id": "79cfec58.cfc6a4",
    "type": "function",
    "z": "54963c28.722b74",
    "name": "Extract product ids",
    "func": "msg.payload = msg.payload.products;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 620,
    "y": 110,
    "wires": [
      [
        "698d16a4.12e9c"
      ]
    ]
  },
  {
    "id": "698d16a4.12e9c",
    "type": "split",
    "z": "54963c28.722b74",
    "name": "",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": 1,
    "arraySpltType": "len",
    "stream": false,
    "addname": "",
    "x": 780,
    "y": 110,
    "wires": [
      [
        "ad6e9522.278b68"
      ]
    ]
  },
  {
    "id": "e63f08c6.48cdc8",
    "type": "subflow:e5049f4c.fd313",
    "z": "54963c28.722b74",
    "name": "",
    "x": 380,
    "y": 210,
    "wires": [
      [
        "ace5214c.8619b8"
      ]
    ]
  },
  {
    "id": "ad6e9522.278b68",
    "type": "function",
    "z": "54963c28.722b74",
    "name": "Save amount",
    "func": "msg.amount = msg.payload.amount;\nmsg.payload.id = msg.payload.index;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 160,
    "y": 210,
    "wires": [
      [
        "e63f08c6.48cdc8"
      ]
    ]
  },
  {
    "id": "ace5214c.8619b8",
    "type": "function",
    "z": "54963c28.722b74",
    "name": "Restore amount",
    "func": "if (msg.payload === null) {\n    msg.payload = {};\n}\nmsg.payload.amount = msg.amount;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 600,
    "y": 210,
    "wires": [
      [
        "b39443e4.88fb58"
      ]
    ]
  },
  {
    "id": "b39443e4.88fb58",
    "type": "join",
    "z": "54963c28.722b74",
    "name": "",
    "mode": "auto",
    "build": "string",
    "property": "payload",
    "propertyType": "msg",
    "key": "topic",
    "joiner": "\\n",
    "joinerType": "str",
    "accumulate": "false",
    "timeout": "",
    "count": "",
    "x": 780,
    "y": 210,
    "wires": [
      []
    ]
  },
  {
    "id": "837d76c6.49a3f",
    "type": "switch",
    "z": "54963c28.722b74",
    "name": "",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "null"
      },
      {
        "t": "else"
      }
    ],
    "checkall": "true",
    "outputs": 2,
    "x": 460,
    "y": 90,
    "wires": [
      [
        "ec624000.a5d6f"
      ],
      [
        "79cfec58.cfc6a4"
      ]
    ]
  },
  {
    "id": "ec624000.a5d6f",
    "type": "function",
    "z": "54963c28.722b74",
    "name": "Empty result",
    "func": "msg.payload = [];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 600,
    "y": 70,
    "wires": [
      []
    ]
  },
  {
    "id": "f7aba048.0fdbd",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "Compute total price",
    "func": "var products = msg.payload;\nvar totalPrice = products\n    .filter(product => typeof product.price !== \"undefined\")\n    .map(product => product.amount * product.price.discount)\n    .reduce((acc, cur) => acc + cur, 0);\nvar cart = msg.cart.replace(\"Cart_\",\"\");\n\nmsg.payload = {};\nmsg.payload.products = products;\nmsg.payload.totalPrice = totalPrice;\nmsg.payload.cart = cart;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 180,
    "y": 1040,
    "wires": [
      [
        "2289c43a.2463ec"
      ]
    ]
  },
  {
    "id": "2289c43a.2463ec",
    "type": "function",
    "z": "186b7a65.42ec46",
    "name": "Add payment Url",
    "func": "msg.url = \"api/pay\";\nmsg.products = msg.payload;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 400,
    "y": 1040,
    "wires": [
      [
        "68fb2f30.82ce38"
      ]
    ]
  },
  {
    "id": "68fb2f30.82ce38",
    "type": "template",
    "z": "186b7a65.42ec46",
    "name": "js",
    "field": "payload.script",
    "fieldType": "msg",
    "format": "javascript",
    "syntax": "plain",
    "template": "$(document).ready(function(e) {\n    $(\"form[ajax=true]\").submit(function(e) {\n        e.preventDefault();\n        var form_data = $(this).serialize();\n        var form_url = $(this).attr(\"action\");\n        var form_method = $(this).attr(\"method\").toUpperCase();\n        $.ajax({\n            url: form_url,\n            type: form_method,\n            data: form_data,\n            cache: false,\n            success: function(returnhtml) {\n                $(\"#result\").html(returnhtml);\n            }\n        });\n    });\n});",
    "output": "str",
    "x": 580,
    "y": 1040,
    "wires": [
      [
        "6b4d6128.e2cfc8"
      ]
    ]
  },
  {
    "id": "6b4d6128.e2cfc8",
    "type": "template",
    "z": "186b7a65.42ec46",
    "name": "css",
    "field": "payload.style",
    "fieldType": "msg",
    "format": "css",
    "syntax": "plain",
    "template": "body {\n    margin: 0 auto;\n    height: 100vh;\n    box-sizing: border-box;\n    padding: 50px;\n    font: 16px \"Lucida Grande\", Helvetica, Arial, sans-serif;\n    background: #f0f0f0;\n}\n\n.wrapper {\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n}\n\n.form-container {\n  box-sizing: border-box;\n}\n\n.list-container {\n  box-sizing: border-box;\n  position: relative;\n  height: 100%;\n}\n\n.list-container table {\n    width: 100%;\n    background: white;\n    border: 1px solid lightgrey;\n    border-radius: 5px;\n    padding: 5px;\n}\n.list-container table thead tr {\n    background: firebrick;\n    color: white;\n}\n.list-container table thead tr th {\n    padding: 5px;\n}\n.list-container table tbody tr td {\n    border-bottom: 1px solid lightgrey;\n}\n.list-container table tbody tr td {\n    padding: 5px;\n}\n\n.product-id {\n    width 50px;\n    text-align: center;\n}\n.product-title {\n    text-overflow: ellipsis;\n    overflow: hidden;\n    white-space: nowrap;\n}\n.product-price, .product-discount {\n    width: 150px;\n}\n\ntbody .product-price, tbody .product-discount {\n    text-align: right;\n}\n.product-amount {\n    width: 100px;\n    text-align: center;\n}",
    "output": "str",
    "x": 580,
    "y": 1080,
    "wires": [
      [
        "bcc5c544.5dbb98"
      ]
    ]
  },
  {
    "id": "bcc5c544.5dbb98",
    "type": "template",
    "z": "186b7a65.42ec46",
    "name": "html",
    "field": "payload",
    "fieldType": "msg",
    "format": "html",
    "syntax": "mustache",
    "template": "<html>\n<head>\n    <title>Products in cart {{payload.cart}}</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n    <script src=\"http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js\"></script>\n    <style>{{{payload.style}}}</style>\n    <script>{{{payload.script}}}</script>\n</head>\n<body>\n  <div class=\"wrapper\">\n    <h1>Products in cart {{payload.cart}}</h1>\n    <div class=\"form-container\">\n        <div>\n            <form method=\"post\" action=\"/{{url}}\" ajax=\"true\">\n                <div class=\"total-price\">Total: {{payload.totalPrice}} </div>\n                <input type=\"hidden\" name=\"totalPrice\" value=\"{{payload.totalPrice}}\">\n                <input type=\"hidden\" name=\"cart\" value=\"{{payload.cart}}\">\n                <input type=\"submit\" value=\"Buy\">\n            </form>\n        </div>\n        <div class=\"output-div\">\n            <span class=\"feedback-output\" id=\"result\"></span>\n        </div>\n    </div>\n    <div class=\"list-container\">\n        <table>\n            <thead>\n                <tr>\n                    <th class=\"product-id\">Id</th>\n                    <th class=\"product-title\">Product</th>\n                    <th class=\"product-price\">Full price</th>\n                    <th class=\"product-discount\">Discount price</th>\n                    <th class=\"product-amount\">Amount</th>\n                </tr>\n            </thead>\n            <tbody>\n                {{#payload.products}}\n                <tr>\n                    <td class=\"product-id\">{{index}}</td>\n                    <td class=\"product-title\">{{title}}</td>\n                    <td class=\"product-price\">{{price.original}} {{price.currency}}</td>\n                    <td class=\"product-discount\">{{price.discount}} {{price.currency}}</td>\n                    <td class=\"product-amount\">{{amount}}</td>\n                </tr>\n                {{/payload.products}}\n            </tbody>\n        </table>\n    </div>\n  </div>\n</body>\n</html>",
    "output": "str",
    "x": 580,
    "y": 1120,
    "wires": [
      [
        "bba200a8.a8a65"
      ]
    ]
  },
  {
    "id": "746a5c6a.81aecc",
    "type": "switch",
    "z": "186b7a65.42ec46",
    "name": "",
    "property": "wrongId",
    "propertyType": "msg",
    "rules": [
      {
        "t": "true"
      },
      {
        "t": "false"
      }
    ],
    "checkall": "true",
    "outputs": 2,
    "x": 460,
    "y": 940,
    "wires": [
      [
        "c45431a2.fbdb58"
      ],
      [
        "e6de9755.a7b94"
      ]
    ]
  },
  {
    "id": "c45431a2.fbdb58",
    "type": "template",
    "z": "186b7a65.42ec46",
    "name": "html",
    "field": "payload",
    "fieldType": "msg",
    "format": "html",
    "syntax": "mustache",
    "template": "<html>\n<head>\n    <title>Error 404</title>\n    <meta name=\"viewport\" content=\"initial-scale=1.0, user-scalable=no\">\n    <meta charset=\"utf-8\">\n</head>\n<body>\n    <h1>Error 404 - Cart not found</h1>\n</body>\n</html>",
    "output": "str",
    "x": 580,
    "y": 910,
    "wires": [
      [
        "32f74ac6.c7b38e"
      ]
    ]
  }
]
