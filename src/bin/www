#!/usr/bin/env node
'use strict';
const httpServer = require('../servers/http-server');
const tcpServer = require('../servers/tcp-server');

const ioDevice = require('../devices/io-device');
const digitalDevice = require('../devices/digital-device');
const analogicalDevice = require('../devices/analogical-device');
const positionDevice = require('../devices/position-device');
const smartSupermarket = require('../smart-supermarket');
const smarketbot = require('../telegram_bot/telegram_bot');


class serverContainer {
    constructor(...servers) {
        this.servers = servers;
    }

    start() {
        this.servers.forEach(s => s.start());
    }
}

const shelves = new ioDevice("Shelves");
shelves.addDevice("S1_Temp", new analogicalDevice("Shelf 1 temperature", 4.0));
for (let i = 1; i <= 5; i++) {
    shelves.addDevice(`S${i}_Add`, new analogicalDevice(`Shelf ${i} added product id`, -1));
    shelves.addDevice(`S${i}_Rem`, new analogicalDevice(`Shelf ${i} removed product id`, -1));
}

const shoppingCarts = new ioDevice("ShoppingCarts");
for (let i = 0; i < 20; i++) {
    shoppingCarts.addDevice(`Cart_${i}`, new positionDevice(`Cart ${i} position`, {x:0, y:0}));
    shoppingCarts.addDevice(`Cart_${i}_Add`, new analogicalDevice(`Cart ${i} added product id`, -1));
    shoppingCarts.addDevice(`Cart_${i}_Rem`, new analogicalDevice(`Cart ${i} removed product id`, -1));
}

const theftProtection = new ioDevice("TheftProtection");
for (let i = 1; i <= 2; i++) {
    theftProtection.addDevice(`T${i}_Alarm`, new digitalDevice(`Totem ${i} alarm active`, false));
    theftProtection.addDevice(`T${i}_Detector`, new analogicalDevice(`Totem ${i} detected product id`, -1));
}

const smartSupermarketApp = new smartSupermarket(shelves, shoppingCarts, theftProtection);
const bot = new smarketbot('../telegram_bot/token');

new serverContainer(
    new httpServer(process.env.PORT || '3000', smartSupermarketApp),
    new tcpServer(9090, shelves),
    new tcpServer(9091, shoppingCarts),
    new tcpServer(9092, theftProtection)
).start();